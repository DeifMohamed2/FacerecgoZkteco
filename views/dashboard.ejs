<%- include('partials/header', { title: 'Dashboard' }) %>

<div class="row mb-4">
    <div class="col-md-12">
        <h2 class="mb-4"><i class="bi bi-speedometer2 me-2"></i>Dashboard</h2>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-4">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-people text-primary"></i> Total Students</h5>
                <h2 class="text-primary" id="totalStudents">0</h2>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-clock-history text-success"></i> Today's Attendance</h5>
                <h2 class="text-success" id="todayAttendance">0</h2>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-device-hdd text-info"></i> Connected Devices</h5>
                <h2 class="text-info" id="connectedDevices">0</h2>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-router me-2"></i>Device Status</h5>
            </div>
            <div class="card-body">
                <div id="deviceStatusContainer">
                    <p class="text-muted">Loading device status...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function updateStats() {
        // Update students count
        fetch('/api/students')
            .then(res => res.json())
            .then(students => {
                document.getElementById('totalStudents').textContent = students.length;
            });

        // Update attendance stats
        fetch('/api/attendance/stats')
            .then(res => res.json())
            .then(stats => {
                document.getElementById('todayAttendance').textContent = stats.todayCount;
            });

        // Update device status
        updateDeviceStatus();
    }

    function updateDeviceStatus() {
        fetch('/api/devices/status')
            .then(res => res.json())
            .then(devices => {
                const container = document.getElementById('deviceStatusContainer');
                const connectedCount = devices.filter(d => d.connected).length;
                document.getElementById('connectedDevices').textContent = connectedCount;

                if (devices.length === 0) {
                    container.innerHTML = '<p class="text-muted">No devices configured</p>';
                    return;
                }

                let html = '<div class="row">';
                devices.forEach(device => {
                    const statusClass = device.connected ? 'status-connected' : 'status-disconnected';
                    const statusIcon = device.connected ? 'bi-check-circle-fill' : 'bi-x-circle-fill';
                    html += `
                        <div class="col-md-4 mb-3">
                            <div class="card device-card">
                                <div class="card-body">
                                    <h6 class="card-title">${device.name}</h6>
                                    <p class="card-text mb-1"><small class="text-muted">IP: ${device.ip}:${device.port}</small></p>
                                    <p class="card-text mb-1"><small class="text-muted">SN: ${device.sn || 'N/A'}</small></p>
                                    <span class="status-badge ${statusClass}">
                                        <i class="bi ${statusIcon} me-1"></i>${device.status}
                                    </span>
                                    ${device.lastSeen ? `<p class="mt-2 mb-0"><small class="text-muted">Last seen: ${new Date(device.lastSeen).toLocaleString()}</small></p>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                container.innerHTML = html;
            });
    }

    // Update stats on load
    updateStats();
    
    // Update device status every 10 seconds
    setInterval(updateDeviceStatus, 10000);
</script>

<%- include('partials/footer') %>
